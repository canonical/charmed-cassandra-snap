# Output all metric names in lowercase for Prometheus compatibility
lowercaseOutputName: true

# Output all label names in lowercase as well
lowercaseOutputLabelNames: true

# Define which JMX MBeans are allowed (whitelisted) for export as metrics
whitelistObjectNames: [
  # Table-level metrics
  "org.apache.cassandra.metrics:type=Table,name=WriteLatency,*",
  "org.apache.cassandra.metrics:type=Table,name=ReadLatency,*",

  # CQL query execution metrics
  "org.apache.cassandra.metrics:type=CQL,name=RegularStatementsExecuted,*",
  "org.apache.cassandra.metrics:type=CQL,name=PreparedStatementsExecuted,*",

  # Compaction metrics
  "org.apache.cassandra.metrics:type=Compaction,name=PendingTasks,*",
  "org.apache.cassandra.metrics:type=Compaction,name=CompletedTasks,*",
  "org.apache.cassandra.metrics:type=Compaction,name=BytesCompacted,*",
  "org.apache.cassandra.metrics:type=Compaction,name=TotalCompactionsCompleted,*",

  # Client request-level metrics
  "org.apache.cassandra.metrics:type=ClientRequest,name=Latency,*",
  "org.apache.cassandra.metrics:type=ClientRequest,name=Unavailables,*",
  "org.apache.cassandra.metrics:type=ClientRequest,name=Timeouts,*",

  # Storage metrics
  "org.apache.cassandra.metrics:type=Storage,name=Exceptions,*",
  "org.apache.cassandra.metrics:type=Storage,name=TotalHints,*",
  "org.apache.cassandra.metrics:type=Storage,name=TotalHintsInProgress,*",
  "org.apache.cassandra.metrics:type=Storage,name=Load,*",

  # Connection metrics
  "org.apache.cassandra.metrics:type=Connection,name=TotalTimeouts,*",

  # Thread pool activity
  "org.apache.cassandra.metrics:type=ThreadPools,name=CompletedTasks,*",
  "org.apache.cassandra.metrics:type=ThreadPools,name=PendingTasks,*",
  "org.apache.cassandra.metrics:type=ThreadPools,name=ActiveTasks,*",
  "org.apache.cassandra.metrics:type=ThreadPools,name=TotalBlockedTasks,*",
  "org.apache.cassandra.metrics:type=ThreadPools,name=CurrentlyBlockedTasks,*",

  # Dropped message metrics
  "org.apache.cassandra.metrics:type=DroppedMessage,name=Dropped,*",

  # Key cache performance
  "org.apache.cassandra.metrics:type=Cache,scope=KeyCache,name=HitRate,*",
  "org.apache.cassandra.metrics:type=Cache,scope=KeyCache,name=Hits,*",
  "org.apache.cassandra.metrics:type=Cache,scope=KeyCache,name=Requests,*",
  "org.apache.cassandra.metrics:type=Cache,scope=KeyCache,name=Entries,*",
  "org.apache.cassandra.metrics:type=Cache,scope=KeyCache,name=Size,*",

  # Streaming metrics
  "org.apache.cassandra.metrics:type=Streaming,name=TotalIncomingBytes,*",
  "org.apache.cassandra.metrics:type=Streaming,name=TotalOutgoingBytes,*",

  # Connected clients
  "org.apache.cassandra.metrics:type=Client,name=connectedNativeClients,*",
  "org.apache.cassandra.metrics:type=Client,name=connectedThriftClients,*",

  # Failure detector metrics
  "org.apache.cassandra.net:type=FailureDetector,*"
]

# === Metric transformation rules ===
# Order matters - first matching rule wins, so put most specific rules first
rules:
  # 1. Failure detector metrics (different package structure)
  - pattern: "org.apache.cassandra.net<type=FailureDetector><>(DownEndpointCount)"
    name: cassandra_net_failure_detector_down_endpoints

  # 2. Table-level metrics with keyspace and scope (most specific)
  - pattern: "org.apache.cassandra.metrics<type=Table, keyspace=([^,]*), scope=([^,]*), name=([^,]*)><>(Count|Mean|95thPercentile)"
    name: cassandra_table_$3_$4
    labels:
      keyspace: "$1"
      table: "$2"

  # 3. Client request metrics with scope
  - pattern: "org.apache.cassandra.metrics<type=ClientRequest, scope=([^,]*), name=([^,]*)><>(Count|Mean|95thPercentile)"
    name: cassandra_client_request_$2_$3
    labels:
      request_type: "$1"

  # 4. Cache metrics with scope
  - pattern: "org.apache.cassandra.metrics<type=Cache, scope=([^,]*), name=([^,]*)><>(Count|Value|Mean)"
    name: cassandra_cache_$2_$3
    labels:
      cache_type: "$1"

  # 5. ThreadPools metrics with path and scope
  - pattern: "org.apache.cassandra.metrics<type=ThreadPools, path=([^,]*), scope=([^,]*), name=([^,]*)><>(Count|Value)"
    name: cassandra_thread_pools_$3_$4
    labels:
      path: "$1"
      thread_pool: "$2"

  # 6. ThreadPools metrics with only scope
  - pattern: "org.apache.cassandra.metrics<type=ThreadPools, scope=([^,]*), name=([^,]*)><>(Count|Value)"
    name: cassandra_thread_pools_$2_$3
    labels:
      thread_pool: "$1"

  # 7. DroppedMessage metrics with scope
  - pattern: "org.apache.cassandra.metrics<type=DroppedMessage, scope=([^,]*), name=([^,]*)><>(Count|Value)"
    name: cassandra_dropped_message_$2_$3
    labels:
      message_type: "$1"

  # 8. Connection metrics with scope (address)
  - pattern: "org.apache.cassandra.metrics<type=Connection, scope=([^,]*), name=([^,]*)><>(Count|Value)"
    name: cassandra_connection_$2_$3
    labels:
      address: "$1"

  # 9. Streaming metrics with scope (address)
  - pattern: "org.apache.cassandra.metrics<type=Streaming, scope=([^,]*), name=([^,]*)><>(Count|Value)"
    name: cassandra_streaming_$2_$3
    labels:
      address: "$1"

  # 10. Keyspace-level metrics with keyspace
  - pattern: "org.apache.cassandra.metrics<type=Keyspace, keyspace=([^,]*), name=([^,]*)><>(Count|Mean|95thPercentile)"
    name: cassandra_keyspace_$2_$3
    labels:
      keyspace: "$1"

  # 11. Simple metrics without scope - Compaction
  - pattern: "org.apache.cassandra.metrics<type=Compaction, name=([^,]*)><>(Count|Value)"
    name: cassandra_compaction_$1_$2

  # 12. Simple metrics without scope - Storage
  - pattern: "org.apache.cassandra.metrics<type=Storage, name=([^,]*)><>(Count|Value)"
    name: cassandra_storage_$1_$2

  # 13. Simple metrics without scope - CQL
  - pattern: "org.apache.cassandra.metrics<type=CQL, name=([^,]*)><>(Count|Value)"
    name: cassandra_cql_$1_$2

  # 14. Simple metrics without scope - Client
  - pattern: "org.apache.cassandra.metrics<type=Client, name=([^,]*)><>(Count|Value)"
    name: cassandra_client_$1_$2
